# NutriMind Telegram Bot ‚Äî README

–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç –ø–æ –ø–∏—Ç–∞–Ω–∏—é –¥–ª—è Telegram: –ø–æ–¥–±–∏—Ä–∞–µ—Ç –±–ª—é–¥–∞ (–∑–∞–≤—Ç—Ä–∞–∫/–æ–±–µ–¥/—É–∂–∏–Ω) –∏–∑ –ø–æ–¥–∫–ª—é—á—ë–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –∏ –ø–æ –∑–∞–ø—Ä–æ—Å—É –≤—ã–¥–∞—ë—Ç –∫–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç—å –ø—Ä–æ–¥—É–∫—Ç–∞ (–Ω–∞ 100 –≥) —á–µ—Ä–µ–∑ –≤–Ω–µ—à–Ω–µ–µ API.

---

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1) –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è
- Python 3.10+
- –ê–∫–∫–∞—É–Ω—Ç OpenAI (API-–∫–ª—é—á)
- Telegram Bot Token (—á–µ—Ä–µ–∑ @BotFather)

### 2) –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
```bash
git clone <repo-url> nutrimind-bot
cd nutrimind-bot
python -m venv .venv
# Windows:
.\.venv\Scriptsctivate
# macOS/Linux:
source .venv/bin/activate
```

### 3) –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
```bash
pip install -U pip
pip install openai python-telegram-bot==20.* python-dotenv requests
```

### 4) –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `.env` –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞:
```
OPENAI_API_KEY=sk-...–≤–∞—à_–∫–ª—é—á...
TELEGRAM_BOT_TOKEN=...—Ç–æ–∫–µ–Ω_–±–æ—Ç–∞...
ASSISTANT_ID=asst_...ID_–≤–∞—à–µ–≥–æ_–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞...
```

### 5) –ó–∞–ø—É—Å–∫
```bash
python bot.py
```
–í Telegram –Ω–∞–ø–∏—à–∏—Ç–µ –±–æ—Ç—É, –Ω–∞–ø—Ä–∏–º–µ—Ä:  
`–ß—Ç–æ –ø—Ä–∏–≥–æ—Ç–æ–≤–∏—Ç—å –Ω–∞ —É–∂–∏–Ω –±–µ–∑ –º–æ–ª–æ—á–∫–∏?`  
`–ö–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç—å 100 –≥ –≥—Ä–µ—á–∫–∏`

---

## üß† –ß—Ç–æ –≤–Ω—É—Ç—Ä–∏

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
```
project/
‚îú‚îÄ bot.py                    # Telegram-–±–æ—Ç + –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å OpenAI Assistants
‚îú‚îÄ tools/
‚îÇ  ‚îú‚îÄ __init__.py
‚îÇ  ‚îî‚îÄ nutrition_lookup.py    # lookup_product_nutrition: –∫–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç—å –∏ –ë–ñ–£ (Open Food Facts)
‚îî‚îÄ .env
```

### –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
- **Assistants API (OpenAI)**: –¥–∏–∞–ª–æ–≥ + File Search (–≤–∞—à–µ –≤–µ–∫—Ç–æ—Ä–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ).
- **Function call**: `lookup_product_nutrition(product)` ‚Äî –ø–æ–∏—Å–∫ –∫–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç–∏/–ë–ñ–£ –Ω–∞ 100 –≥ —á–µ—Ä–µ–∑ Open Food Facts (–±–µ–∑ –∫–ª—é—á–µ–π).
- **–°–∞–Ω–∏—Ç–∞–π–∑–µ—Ä Markdown**: —É–±–∏—Ä–∞–µ—Ç —Å–ª—É–∂–µ–±–Ω—ã–µ –º–µ—Ç–∫–∏ `„Äê‚Ä¶„Äë`, –∏–º–µ–Ω–∞ —Ñ–∞–π–ª–æ–≤ (`.json/.pdf`), URL –∏ –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã ‚Äî –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —Ä–µ–Ω–¥–µ—Ä–∞ –≤ Telegram.
- **parse_mode**: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `Markdown` (–Ω–µ V2), —á—Ç–æ–±—ã –º–∏–Ω–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ.

---

## üîß –§—É–Ω–∫—Ü–∏–∏ –∏ —Ñ–∞–π–ª—ã

### `tools/nutrition_lookup.py`
- `lookup_product_nutrition(product: str, per="100g") -> dict`  
  –ò—â–µ—Ç –ø—Ä–æ–¥—É–∫—Ç –≤ Open Food Facts –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
  ```json
  {
    "status": "ok",
    "name": "Chicken breast",
    "per": "100g",
    "kcal": 165.0,
    "protein_g": 31.0,
    "fat_g": 3.6,
    "carbs_g": 0.0,
    "fiber_g": null,
    "sugars_g": null,
    "salt_g": 0.12,
    "source": "openfoodfacts",
    "barcode": "...",
    "url": "..."
  }
  ```
  –í–æ–∑–º–æ–∂–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã: `ok`, `not_found`, `incomplete`, `unsupported_per`.

### `bot.py`
- `sanitize_markdown(text)` ‚Äî —á–∏—Å—Ç–∏—Ç –æ—Ç–≤–µ—Ç—ã –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –≤ Telegram.
- `get_or_create_thread_id(chat_id)` ‚Äî —Å–æ–∑–¥–∞—ë—Ç/–∫–µ—à–∏—Ä—É–µ—Ç Thread –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–∏–∞–ª–æ–≥–∞.
- `run_and_wait(thread_id, assistant_id)` ‚Äî –∑–∞–ø—É—Å–∫–∞–µ—Ç Run –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç `requires_action`:
  - –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –≤—ã–∑–æ–≤ `lookup_product_nutrition`,
  - –≤—ã–∑—ã–≤–∞–µ—Ç –ª–æ–∫–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –∏–∑ `tools`,
  - –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `submit_tool_outputs`,
  - –∂–¥—ë—Ç `completed`.
- Telegram handlers:
  - `/start`
  - –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (–ø–µ—Ä–µ–¥–∞—ë—Ç –∏—Ö –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç—É –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç).

---

## üßæ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ (–∫—Ä–∞—Ç–∫–æ)

–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è –º–æ–¥–µ–ª—å: **gpt-4.1-mini**  
–í—ã–±–µ—Ä–∏—Ç–µ **Text** –≤ Output. –ü–æ–¥–∫–ª—é—á–∏—Ç–µ File Search (–≤–∞—à–µ –≤–µ–∫—Ç–æ—Ä–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ).

**System Instructions (—Å—É—Ç—å):**
- –ü–æ–¥–±–∏—Ä–∞–π –±–ª—é–¥–∞ (–∑–∞–≤—Ç—Ä–∞–∫/–æ–±–µ–¥/—É–∂–∏–Ω), –±—É–¥—å –∫—Ä–∞—Ç–∫–∏–º –∏ –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–º.
- –î–µ—Å–µ—Ä—Ç—ã –Ω–µ –ø—Ä–µ–¥–ª–∞–≥–∞–π –∫–∞–∫ –æ—Å–Ω–æ–≤–Ω–æ–µ; –ø–æ —Å–æ–≥–ª–∞—Å–∏—é ‚Äî 1 –¥–µ—Å–µ—Ä—Ç –æ—Ç–¥–µ–ª—å–Ω–æ.
- –ü—Ä–∏ –∑–∞–ø—Ä–æ—Å–∞—Ö –∫–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç–∏ –ø—Ä–æ–¥—É–∫—Ç–∞ –≤—ã–∑—ã–≤–∞–π `lookup_product_nutrition`.
- **–ù–µ –≤—Å—Ç–∞–≤–ª—è–π —Å—Å—ã–ª–∫–∏/URL/–∏–º–µ–Ω–∞ —Ñ–∞–π–ª–æ–≤, –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–π —Å–ª—É–∂–µ–±–Ω—ã–µ —Ü–∏—Ç–∞—Ç—ã `„Äê‚Ä¶„Äë`.**
- –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ (Telegram Markdown), –ø—Ä–∏–º–µ—Ä:
  ```
  üç¥ *–ù–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞*
  ü•ó _–ö–∞—Ç–µ–≥–æ—Ä–∏—è:_ –∑–∞–≤—Ç—Ä–∞–∫ / –æ–±–µ–¥ / —É–∂–∏–Ω
  üî• _–ö–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç—å:_ ~NNN –∫–∫–∞–ª (–µ—Å–ª–∏ –µ—Å—Ç—å)
  üßÇ _–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã:_ ...
  üë©‚Äçüç≥ _–®–∞–≥–∏:_ 1‚Äì3 —à–∞–≥–∞
  ```
- –†–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã: `*bold*`, `_italic_`, `[inline URL](http://...)`, `[inline mention](tg://user?id=...)`, `` `inline code` ``, —Ç—Ä–æ–π–Ω—ã–µ –±—ç–∫—Ç–∏–∫–∏ –¥–ª—è –±–ª–æ–∫–æ–≤.

**Function schema (–≤ UI ‚Üí Tools ‚Üí Function):**
```json
{
  "name": "lookup_product_nutrition",
  "description": "–ù–∞–π—Ç–∏ –∫–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç—å –∏ –ë–ñ–£ –ø–æ –ø—Ä–æ–¥—É–∫—Ç—É (Open Food Facts)",
  "strict": true,
  "parameters": {
    "type": "object",
    "properties": {
      "product": {
        "type": "string",
        "description": "–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä: '–≥—Ä–µ—á–∫–∞', 'apple', '–∫—É—Ä–∏–Ω–∞—è –≥—Ä—É–¥–∫–∞'"
      }
    },
    "required": ["product"],
    "additionalProperties": false
  }
}
```

---

## üí¨ –ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤
- ¬´–ß—Ç–æ –ø—Ä–∏–≥–æ—Ç–æ–≤–∏—Ç—å –Ω–∞ —É–∂–∏–Ω –±–µ–∑ –º–æ–ª–æ—á–∫–∏ –∑–∞ 20 –º–∏–Ω—É—Ç?¬ª  
- ¬´–ö–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç—å 100 –≥ –∫—É—Ä–∏–Ω–æ–π –≥—Ä—É–¥–∫–∏¬ª  
- ¬´–ë–ñ–£ —Ç–≤–æ—Ä–æ–≥ 5% (–Ω–∞ 100 –≥)¬ª  
- ¬´–ï—â—ë –≤–∞—Ä–∏–∞–Ω—Ç—ã —É–∂–∏–Ω–∞, –Ω–æ –±–µ–∑ —Ä—ã–±—ã¬ª

---

## ü©π –¢—Ä–∞–±–ª—à—É—Ç–∏–Ω–≥
- **400: ‚ÄúCan't add messages ‚Ä¶ while a run is active.‚Äù**  
  –ü—Ä–∏—á–∏–Ω–∞: –≤ —Ç—Ä–µ–¥–µ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π Run –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ `requires_action`.  
  –†–µ—à–µ–Ω–∏–µ: –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `run_and_wait(...)` (–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–π—Ç–µ tool-calls –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–π—Ç–µ `submit_tool_outputs`) ‚Äî –≤ –∫–æ–¥–µ —É–∂–µ —Å–¥–µ–ª–∞–Ω–æ.

- **–û—Ç–≤–µ—Ç —Å–ª–æ–º–∞–Ω/–≤–∏–¥–Ω—ã `„Äê‚Ä¶„Äë` –∏–ª–∏ `*.json`**  
  –û—Ç–ø—Ä–∞–≤–ª—è–π—Ç–µ —Ç–µ–∫—Å—Ç —á–µ—Ä–µ–∑:
  ```python
  clean = sanitize_markdown(reply_text)
  await message.reply_text(clean, parse_mode="Markdown", disable_web_page_preview=True)
  ```
  –ò –≤ System Instructions –∑–∞–ø—Ä–µ—Ç–∏—Ç–µ –≤—ã–≤–æ–¥ —Å—Å—ã–ª–æ–∫/—Ü–∏—Ç–∞—Ç.

- **Assistants API DeprecationWarning**  
  –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ Responses API. –î–ª—è —É—á–µ–±–Ω–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å, –ø–æ–∑–∂–µ –ª–µ–≥–∫–æ –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏.

---

## üó∫Ô∏è –ü–ª–∞–Ω —É–ª—É—á—à–µ–Ω–∏–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- –§–æ–ª–±—ç–∫ –Ω–∞ Nutritionix/Edamam, –µ—Å–ª–∏ OFF –¥–∞—ë—Ç `not_found`.
- –ò—Å—Ç–æ—Ä–∏—è ¬´–ø–æ—Å–ª–µ–¥–Ω–∏—Ö –±–ª—é–¥¬ª (–Ω–µ –ø–æ–≤—Ç–æ—Ä—è—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏).
- –£—á—ë—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–±–µ–∑ –≥–ª—é—Ç–µ–Ω–∞/–º–æ–ª–æ—á–∫–∏) –≤ –ø–∞–º—è—Ç–∏/–ë–î.
- –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ Responses API.

---

## üìÑ –õ–∏—Ü–µ–Ω–∑–∏—è
MIT 
